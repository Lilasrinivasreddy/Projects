-- CTE for Entity Relation Lineage Metadata
WITH dof_entity_relation_lineage_meta_v AS (
  SELECT DISTINCT
    lm.relationship_id,
    lm.project_name,
    CASE 
      WHEN lm.sub_process = 'soi_egress' THEN CONCAT('cfi_send_soi_egress_', lm.process_name)
      ELSE lm.process_name
    END AS process_name,
    lm.source_type,
    lm.target_type,
    lm.sub_process,
    lm.application_name,
    lm.step_id,
    lm.env_name,
    TRIM(REPLACE(lm.process_source, '\n', '')) AS process_source,
    TRIM(REPLACE(lm.process_target, '\n', '')) AS process_target
  FROM `vz-it-pr-hgrv-aidedo-0.aid_epdo_prd_tbls_nogsam_v.dof_entity_relation_meta` lm
  INNER JOIN `vz-it-pr-hgrv-aidedo-0.aid_epdo_prd_tbls_nogsam_v.dof_process_meta` pm
    ON lm.process_name = pm.process_name
  WHERE pm.is_active = 'Y'
    AND (TRIM(lm.process_target) <> '' OR TRIM(lm.process_source) <> '')
    AND (lm.process_target IS NOT NULL OR lm.process_source IS NOT NULL)
),

-- CTE for Process Monitor Lineage Report
dof_process_monitor_lineage_latest_rpt_v AS (
  SELECT DISTINCT
    rpt.process_id,
    rpt.program_name,
    rpt.project_name,
    CASE
      WHEN rpt.sub_process = 'soi_egress' THEN CONCAT('cfi_send_soi_egress_', rpt.process_name)
      ELSE rpt.process_name
    END AS process_name,
    rpt.process_status,
    rpt.frequency,
    rpt.process_date,
    rpt.schedule_time,
    rpt.sla_time,
    rpt.expected_datetime,
    rpt.start_time,
    rpt.end_time,
    rpt.source_type,
    rpt.target_type,
    rpt.source_name,
    rpt.target_name,
    rpt.application_name,
    rpt.is_valid,
    rpt.monitor_date,
    COUNTIF(UPPER(rpt.process_status) IN ('PENDING')) OVER (PARTITION BY rpt.program_name, rpt.project_name, rpt.process_name, rpt.process_date) AS pending_instance_count,
    COUNTIF(UPPER(rpt.process_status) = 'SUCCESS') OVER (PARTITION BY rpt.program_name, rpt.project_name, rpt.process_name, rpt.process_date) AS success_instance_count,
    COUNTIF(UPPER(rpt.process_status) IN ('FAILURE', 'FAILED')) OVER (PARTITION BY rpt.program_name, rpt.project_name, rpt.process_name, rpt.process_date) AS failed_instance_count,
    COUNTIF(UPPER(rpt.process_status) IN ('WAIT', 'HELD', 'PROGRESS')) OVER (PARTITION BY rpt.program_name, rpt.project_name, rpt.process_name, rpt.process_date) AS others_instance_count
  FROM `vz-it-pr-hgrv-aidedo-0.aid_epdo_prd_tbls_nogsam_v.dof_process_monitor_rpt` rpt
  WHERE rpt.is_valid = TRUE
),

-- Final Query for Daily Records
dof_lineage_diagram_etl AS (
  SELECT
    COALESCE(map.mapped_program_name, process_report.program_name) AS project_name,
    process_report.process_id,
    process_report.process_date,
    process_report.sub_process AS subprocess_name,
    process_report.process_poc,
    process_report.frequency,
    process_report.is_critical,
    process_report.scheduler_name,
    COALESCE(process_meta.notify_failure, 'Y') AS notify_fails,
    process_meta.failure_notification_email_list,
    COALESCE(process_meta.notify_success, 'N') AS notify_success,
    process_meta.success_notification_email_list,
    process_meta.is_active,
    process_report.application_name,
    process_meta.source_environment,
    process_meta.env_name,
    process_meta.source_servername,
    process_meta.target_environment,
    process_meta.target_servername,
    entity.process_source AS source,
    entity.process_target AS target,
    process_report.source_type,
    process_report.target_type,
    process_report.process_name,
    IF(process_report.target_count = 0, NULL, process_report.target_count) AS target_count,
    ARRAY_AGG(IFNULL(CAST(process_report.expected_datetime AS STRING FORMAT 'yyyy-MM-dd HH:mm:ss'), '')) AS sla_history,
    ARRAY_AGG(IFNULL(CAST(process_report.start_time AS STRING FORMAT 'yyyy-MM-dd HH:mm:ss'), '')) AS run_hour_history,
    ARRAY_AGG(DISTINCT process_report.process_status) AS run_status_history,
    ARRAY_AGG(DISTINCT process_report.sla_met) AS sla_met_history,
    CAST((MAX(success_instance_count) + MAX(failed_instance_count) + MAX(pending_instance_count) + MAX(others_instance_count)) AS STRING) AS total_instance_count,
    MAX(success_instance_count) AS success_instance_count,
    MAX(failed_instance_count) AS failed_instance_count,
    MAX(pending_instance_count) AS pending_instance_count,
    MAX(others_instance_count) AS others_instance_count
  FROM dof_entity_relation_lineage_meta_v AS entity
  INNER JOIN dof_process_monitor_lineage_latest_rpt_v AS process_report
    ON process_report.project_name = entity.project_name
    AND process_report.sub_process = entity.sub_process
    AND process_report.process_name = entity.process_name
    AND UPPER(process_report.frequency) = 'DAILY'
  LEFT JOIN `vz-it-pr-hgrv-aidedo-0.aid_epdo_prd_tbls_nogsam_v.dof_process_meta` process_meta
    ON process_meta.subprocess_name = process_report.sub_process
    AND process_meta.process_name = process_report.process_name
  LEFT JOIN `vz-it-pr-hgrv-aidedo-0.aid_epdo_prd_tbls_nogsam_v.dof_program_name_mapping_v` map
    ON LOWER(process_report.program_name) = LOWER(map.meta_program_name)
  WHERE process_report.source_type IS NOT NULL
    AND process_report.target_type IS NOT NULL
    AND process_report.process_status IS NOT NULL
    AND process_report.is_valid = TRUE
  GROUP BY
    COALESCE(map.mapped_program_name, process_report.program_name),
    process_report.process_id,
    process_report.process_date,
    process_report.sub_process,
    process_report.process_poc,
    process_report.frequency,
    process_report.is_critical,
    process_report.scheduler_name,
    process_meta.notify_failure,
    process_meta.failure_notification_email_list,
    process_meta.notify_success,
    process_meta.success_notification_email_list,
    process_meta.is_active,
    process_report.application_name,
    process_meta.source_environment,
    process_meta.env_name,
    process_meta.source_servername,
    process_meta.target_environment,
    process_meta.target_servername,
    entity.process_source,
    entity.process_target,
    process_report.source_type,
    process_report.target_type,
    process_report.process_name
)

SELECT * FROM dof_lineage_diagram_etl;
