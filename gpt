SELECT trans_dt AS meas_dt,
       COUNTIF(hrcount != 24) AS meas_value,
       CURRENT_TIMESTAMP() AS load_ts
FROM (
  SELECT trans_dt, device_name,
         COUNT(DISTINCT trans_hr) AS hrcount
  FROM (
    SELECT trans_dt, trans_hr, device_name,
           SUM(CAST(messages_count AS INT64)) AS messagecount
    FROM `vz-it-pr-gudv-dtwndo-0.aid_nwperf_session_ng1_core_tbls_rd_v.lte_kpi_device_ip_address_audit`
    WHERE CAST(trans_dt AS DATE) = CURRENT_DATE() - 16
    GROUP BY 1, 2, 3
    HAVING messagecount > 0
  )
  GROUP BY 1, 2
)
GROUP BY 1;
