--RULE MTD

INSERT INTO
  vz-it-np-izcv-dev-idmcdo-0.dga_dq_tbls.dqaas_meta (
    profile_id,
    profile_type,
    data_lob,
    product_name,
    data_sub_dmn,
    data_src,
    project_name,
    database_name,
    table_name,
    column_name,
    dq_pillar,
    rule_name,
    rule_desc,
    rule_sql,
    active_flag,
    profile_schedule_ts,
    threshold_limit,
    email_distro,
    invalid_records_flag,
    invalid_rec_sql,
    opsgenie_flag,
    opsgenie_api,
    jira_assignee,
    tag_name
  )
SELECT
  rule_id AS profile_id,
  "rule" AS profile_type,
  data_lob AS data_lob,
  "DQ_RULE_CHECK" AS product_name,
  data_sub_dmn AS data_sub_dmn,
  data_src AS data_src,
  CASE
    WHEN data_src = 'GCP' THEN SPLIT(db_name, '.')[SAFE_OFFSET(0)]
    ELSE NULL
  END AS project_name,
  CASE
    WHEN data_src = 'GCP' THEN SPLIT(db_name, '.')[SAFE_OFFSET(1)]
    ELSE db_name
  END AS database_name,
  src_tbl AS table_name,
  src_col AS column_name,
  dq_pillar AS dq_pillar,
  meas_name AS rule_name,
  meas_rule_desc AS rule_desc,
  meas_rule_sql AS rule_sql,
  is_active_flg AS active_flag,
  rule_prfl_schd_ts AS profile_schedule_ts,
  CAST(rule_min_thrsd AS INT64) AS threshold_limit,
  email_distro AS email_distro,
  invalid_rec_flg AS invalid_records_flag,
  invalid_rec_sql AS invalid_rec_sql,
  is_opsgenie_flg AS opsgenie_flag,
  opsgenie_api_key AS opsgenie_api,
  'redvi1f' AS jira_assignee,
  label_tags AS tag_name
FROM
  vz-it-np-izcv-dev-idmcdo-0.dga_dq_tbls.dqaas_rule_prfl_mtd;
-- WHERE is_active_flg='Y';


--AUTO MTD (UPDATED WITH DYNAMIC product_name)

INSERT INTO
  vz-it-np-izcv-dev-idmcdo-0.dga_dq_tbls.dqaas_meta (
    profile_id,
    profile_type,
    data_lob,
    product_name,
    data_sub_dmn,
    data_src,
    project_name,
    database_name,
    table_name,
    incr_date_col,
    incr_date_cond,
    unique_index_cols,
    run_frequency,
    profile_schedule_ts,
    email_distro,
    active_flag,
    table_cde,
    threshold_limit,
    opsgenie_flag,
    opsgenie_api,
    jira_assignee,
    tag_name
  )
SELECT
  auto.prfl_tbl_id AS profile_id,
  "auto" AS profile_type,
  auto.data_lob AS data_lob,
  COALESCE(prod_map.product_name, "DQ_AUTO_CHECK") AS product_name,
  auto.data_sub_dmn AS data_sub_dmn,
  auto.data_src AS data_src,
  CASE
    WHEN auto.data_src = 'GCP' THEN SPLIT(auto.db_name, '.')[SAFE_OFFSET(0)]
    ELSE NULL
  END AS project_name,
  CASE
    WHEN auto.data_src = 'GCP' THEN SPLIT(auto.db_name, '.')[SAFE_OFFSET(1)]
    ELSE auto.db_name
  END AS database_name,
  auto.src_tbl AS table_name,
  auto.incr_dt_col AS incr_date_col,
  auto.incr_dt_cond AS incr_date_cond,
  auto.unq_index_cols AS unique_index_cols,
  auto.auto_prfl_freq AS run_frequency,
  auto.auto_prfl_schd_ts AS profile_schedule_ts,
  auto.email_dist AS email_distro,
  auto.is_active_flg AS active_flag,
  auto.tbl_cde AS table_cde,
  CAST(auto.score_min_threshold AS INT64) AS threshold_limit,
  auto.is_opsgenie_flg AS opsgenie_flag,
  auto.opsgenie_api_key AS opsgenie_api,
  'redvi1f' AS jira_assignee,
  auto.label_tags AS tag_name
FROM
  vz-it-np-izcv-dev-idmcdo-0.dga_dq_tbls.dqaas_auto_prfl_mtd auto
LEFT JOIN
  vz-it-np-izcv-dev-idmcdo-0.dga_dq_tbls.dqaas_auto_rule_prfl_product_mtd prod_map
ON
  auto.data_dmn = prod_map.data_dmn AND
  auto.data_sub_dmn = prod_map.data_sub_dmn AND
  auto.data_bus_elem = prod_map.data_bus_elem AND
  auto.product_name = prod_map.product_name;
-- WHERE auto.is_active_flg = 'Y';


--RULE_CUSTOM MTD

INSERT INTO
  vz-it-np-izcv-dev-idmcdo-0.dga_dq_tbls.dqaas_meta (
    profile_id,
    profile_type,
    data_lob,
    product_name,
    data_sub_dmn,
    data_src,
    project_name,
    database_name,
    table_name,
    column_name,
    dq_pillar,
    incr_date_col,
    incr_date_cond,
    rule_name,
    rule_sql,
    active_flag,
    profile_schedule_ts,
    threshold_limit,
    email_distro,
    opsgenie_flag,
    opsgenie_api,
    jira_assignee
  )
SELECT
  prfl_id AS profile_id,
  "rule_custom" AS profile_type,
  data_lob AS data_lob,
  "DQ_RULE_CUSTOM_CHECK" AS product_name,
  data_sub_dmn AS data_sub_dmn,
  data_src AS data_src,
  CASE
    WHEN data_src = 'GCP' THEN SPLIT(db_name, '.')[SAFE_OFFSET(0)]
    ELSE NULL
  END AS project_name,
  CASE
    WHEN data_src = 'GCP' THEN SPLIT(db_name, '.')[SAFE_OFFSET(1)]
    ELSE db_name
  END AS database_name,
  src_tbl AS table_name,
  src_col AS column_name,
  dq_pillar AS dq_pillar,
  incr_dt_col AS incr_date_col,
  incr_dt_cond AS incr_date_cond,
  meas_name AS rule_name,
  meas_rule_sql AS rule_sql,
  is_active_flg AS active_flag,
  prfl_schd_ts AS profile_schedule_ts,
  CAST(min_threshold AS INT64) AS threshold_limit,
  email_distros AS email_distro,
  is_opsgenie_flg AS opsgenie_flag,
  opsgenie_api_key AS opsgenie_api,
  'redvi1f' AS jira_assignee
FROM
  vz-it-np-izcv-dev-idmcdo-0.dga_dq_tbls.dqaas_profile_mtd;
-- WHERE is_active_flg='Y';
